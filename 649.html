<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p649" style="overflow: hidden; position: relative; background-color: white; width: 770px; height: 1010px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_649{left:110px;bottom:907px;letter-spacing:-0.01px;word-spacing:1.27px;}
#t2_649{left:110px;bottom:888px;word-spacing:0.33px;}
#t3_649{left:110px;bottom:869px;letter-spacing:-0.01px;word-spacing:0.62px;}
#t4_649{left:110px;bottom:849px;letter-spacing:0.02px;word-spacing:2.39px;}
#t5_649{left:110px;bottom:830px;word-spacing:0.08px;}
#t6_649{left:110px;bottom:810px;letter-spacing:0.01px;word-spacing:0.01px;}
#t7_649{left:501px;bottom:810px;letter-spacing:0.12px;}
#t8_649{left:600px;bottom:810px;}
#t9_649{left:110px;bottom:781px;letter-spacing:-0.01px;word-spacing:0.14px;}
#ta_649{left:110px;bottom:762px;letter-spacing:0.01px;word-spacing:0.01px;}
#tb_649{left:136px;bottom:736px;letter-spacing:-0.01px;}
#tc_649{left:136px;bottom:721px;letter-spacing:-0.01px;}
#td_649{left:175px;bottom:721px;letter-spacing:-0.01px;}
#te_649{left:227px;bottom:721px;}
#tf_649{left:240px;bottom:721px;letter-spacing:-0.01px;}
#tg_649{left:285px;bottom:721px;}
#th_649{left:292px;bottom:721px;letter-spacing:-0.01px;}
#ti_649{left:396px;bottom:721px;letter-spacing:-0.01px;}
#tj_649{left:136px;bottom:705px;letter-spacing:-0.01px;}
#tk_649{left:162px;bottom:705px;letter-spacing:-0.01px;}
#tl_649{left:214px;bottom:705px;}
#tm_649{left:227px;bottom:705px;letter-spacing:-0.01px;}
#tn_649{left:253px;bottom:705px;letter-spacing:-0.01px;}
#to_649{left:298px;bottom:705px;}
#tp_649{left:305px;bottom:705px;letter-spacing:-0.01px;}
#tq_649{left:396px;bottom:705px;letter-spacing:-0.01px;}
#tr_649{left:136px;bottom:674px;letter-spacing:-0.01px;}
#ts_649{left:136px;bottom:658px;letter-spacing:-0.01px;}
#tt_649{left:136px;bottom:643px;letter-spacing:-0.01px;}
#tu_649{left:136px;bottom:627px;letter-spacing:-0.01px;}
#tv_649{left:175px;bottom:627px;}
#tw_649{left:181px;bottom:627px;letter-spacing:-0.01px;}
#tx_649{left:253px;bottom:627px;}
#ty_649{left:272px;bottom:627px;letter-spacing:-0.01px;}
#tz_649{left:318px;bottom:627px;}
#t10_649{left:331px;bottom:627px;letter-spacing:-0.01px;}
#t11_649{left:428px;bottom:627px;}
#t12_649{left:441px;bottom:627px;letter-spacing:-0.01px;}
#t13_649{left:467px;bottom:627px;}
#t14_649{left:480px;bottom:627px;letter-spacing:-0.01px;}
#t15_649{left:526px;bottom:627px;}
#t16_649{left:532px;bottom:627px;letter-spacing:-0.01px;}
#t17_649{left:571px;bottom:627px;letter-spacing:-0.01px;}
#t18_649{left:259px;bottom:612px;}
#t19_649{left:272px;bottom:612px;letter-spacing:-0.01px;}
#t1a_649{left:318px;bottom:612px;}
#t1b_649{left:324px;bottom:612px;letter-spacing:-0.01px;}
#t1c_649{left:363px;bottom:612px;letter-spacing:-0.01px;}
#t1d_649{left:136px;bottom:581px;letter-spacing:-0.01px;}
#t1e_649{left:136px;bottom:565px;letter-spacing:-0.01px;}
#t1f_649{left:181px;bottom:565px;}
#t1g_649{left:188px;bottom:565px;letter-spacing:-0.01px;}
#t1h_649{left:220px;bottom:565px;}
#t1i_649{left:227px;bottom:565px;letter-spacing:-0.01px;}
#t1j_649{left:298px;bottom:565px;}
#t1k_649{left:305px;bottom:565px;letter-spacing:-0.01px;}
#t1l_649{left:448px;bottom:565px;letter-spacing:-0.01px;}
#t1m_649{left:136px;bottom:534px;letter-spacing:-0.01px;}
#t1n_649{left:136px;bottom:518px;letter-spacing:-0.01px;}
#t1o_649{left:181px;bottom:518px;}
#t1p_649{left:188px;bottom:518px;letter-spacing:-0.01px;}
#t1q_649{left:220px;bottom:518px;}
#t1r_649{left:227px;bottom:518px;letter-spacing:-0.01px;}
#t1s_649{left:240px;bottom:518px;}
#t1t_649{left:246px;bottom:518px;letter-spacing:-0.01px;}
#t1u_649{left:305px;bottom:518px;}
#t1v_649{left:318px;bottom:518px;letter-spacing:-0.01px;}
#t1w_649{left:474px;bottom:518px;letter-spacing:-0.01px;}
#t1x_649{left:110px;bottom:490px;word-spacing:0.4px;}
#t1y_649{left:606px;bottom:490px;letter-spacing:0.12px;}
#t1z_649{left:110px;bottom:470px;letter-spacing:0.12px;}
#t20_649{left:162px;bottom:470px;word-spacing:2.19px;}
#t21_649{left:110px;bottom:451px;word-spacing:1.84px;}
#t22_649{left:110px;bottom:431px;letter-spacing:0.01px;word-spacing:0.01px;}
#t23_649{left:110px;bottom:412px;letter-spacing:0.01px;word-spacing:1.56px;}
#t24_649{left:110px;bottom:392px;letter-spacing:-0.01px;word-spacing:0.12px;}
#t25_649{left:408px;bottom:392px;letter-spacing:0.12px;}
#t26_649{left:511px;bottom:392px;letter-spacing:0.02px;}
#t27_649{left:110px;bottom:373px;letter-spacing:0.01px;word-spacing:0.07px;}
#t28_649{left:110px;bottom:353px;letter-spacing:-0.03px;word-spacing:0.58px;}
#t29_649{left:110px;bottom:334px;letter-spacing:-0.02px;word-spacing:1.8px;}
#t2a_649{left:110px;bottom:315px;word-spacing:1.21px;}
#t2b_649{left:110px;bottom:296px;letter-spacing:0.01px;word-spacing:2.12px;}
#t2c_649{left:110px;bottom:276px;letter-spacing:0.02px;word-spacing:2.73px;}
#t2d_649{left:110px;bottom:257px;letter-spacing:0.02px;word-spacing:1.76px;}
#t2e_649{left:110px;bottom:238px;letter-spacing:0.02px;word-spacing:0.08px;}
#t2f_649{left:110px;bottom:219px;letter-spacing:-0.03px;word-spacing:0.05px;}
#t2g_649{left:110px;bottom:190px;letter-spacing:-0.02px;word-spacing:0.51px;}
#t2h_649{left:110px;bottom:170px;letter-spacing:-0.01px;word-spacing:0.02px;}
#t2i_649{left:319px;bottom:170px;letter-spacing:0.12px;}
#t2j_649{left:418px;bottom:170px;}
#t2k_649{left:136px;bottom:144px;letter-spacing:-0.01px;}
#t2l_649{left:162px;bottom:144px;letter-spacing:-0.01px;}
#t2m_649{left:207px;bottom:144px;}
#t2n_649{left:220px;bottom:144px;letter-spacing:-0.01px;}
#t2o_649{left:246px;bottom:144px;letter-spacing:-0.01px;}
#t2p_649{left:318px;bottom:144px;}
#t2q_649{left:324px;bottom:144px;letter-spacing:-0.01px;}
#t2r_649{left:350px;bottom:144px;}
#t2s_649{left:357px;bottom:144px;letter-spacing:-0.01px;}
#t2t_649{left:383px;bottom:144px;}
#t2u_649{left:409px;bottom:144px;letter-spacing:-0.01px;}
#t2v_649{left:136px;bottom:113px;letter-spacing:-0.01px;}
#t2w_649{left:514px;bottom:59px;letter-spacing:-0.09px;}
#t2x_649{left:627px;bottom:59px;}
#t2y_649{left:643px;bottom:59px;letter-spacing:-0.1px;}

.s1_649{font-size:16px;font-family:MinionPro-Regular_7yv;color:#000;}
.s2_649{font-size:15px;font-family:UbuntuMono-Regular_7zr;color:#000;}
.s3_649{font-size:13px;font-family:UbuntuMono-Italic_7zm;color:#35586C;}
.s4_649{font-size:13px;font-family:UbuntuMono-Bold_7zh;color:#069;}
.s5_649{font-size:13px;font-family:UbuntuMono-Regular_7zr;color:#008;}
.s6_649{font-size:13px;font-family:UbuntuMono-Regular_7zr;color:#555;}
.s7_649{font-size:13px;font-family:UbuntuMono-Regular_7zr;color:#000;}
.s8_649{font-size:13px;font-family:UbuntuMono-Regular_7zr;color:#C30;}
.s9_649{font-size:13px;font-family:UbuntuMono-Regular_7zr;color:#F60;}
.sa_649{font-size:14px;font-family:MyriadPro-SemiboldCond_7yc;color:#000;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts649" type="text/css" >

@font-face {
	font-family: MinionPro-Regular_7yv;
	src: url("fonts/MinionPro-Regular_7yv.woff") format("woff");
}

@font-face {
	font-family: MyriadPro-SemiboldCond_7yc;
	src: url("fonts/MyriadPro-SemiboldCond_7yc.woff") format("woff");
}

@font-face {
	font-family: UbuntuMono-Bold_7zh;
	src: url("fonts/UbuntuMono-Bold_7zh.woff") format("woff");
}

@font-face {
	font-family: UbuntuMono-Italic_7zm;
	src: url("fonts/UbuntuMono-Italic_7zm.woff") format("woff");
}

@font-face {
	font-family: UbuntuMono-Regular_7zr;
	src: url("fonts/UbuntuMono-Regular_7zr.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg649Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg649" style="-webkit-user-select: none;"><svg id="pdf649" width="770" height="1010" viewBox="0 0 770 1010" style="width:770px; height:1010px; -moz-transform:scale(1); z-index: 0; isolation: isolate;" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<defs>
<clipPath id="c0_649"><path d="M110,930.3v-4.7H660v4.7Z"/></clipPath>
<style type="text/css"><![CDATA[
.g0_649{
fill: none;
stroke: #000;
stroke-width: 0.381;
stroke-linecap: round;
stroke-miterlimit: 10;
}
]]></style>
</defs>
<path clip-path="url(#c0_649)" d="M660,927.9H110" class="g0_649"/>
</svg></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_649" class="t s1_649">MessagePorts (nested arbitrarily deeply within the Message object), then those Mes‐ </span>
<span id="t2_649" class="t s1_649">sagePort objects must also appear as members of the array passed as the second argu‐ </span>
<span id="t3_649" class="t s1_649">ment. Doing this tells Node that it does not need to make a copy of the MessagePort, </span>
<span id="t4_649" class="t s1_649">and can instead just give the existing object to the other thread. The key thing to </span>
<span id="t5_649" class="t s1_649">understand, however, about transferring values between threads is that once a value is </span>
<span id="t6_649" class="t s1_649">transferred, it can no longer be used in the thread that called </span><span id="t7_649" class="t s2_649">postMessage()</span><span id="t8_649" class="t s1_649">. </span>
<span id="t9_649" class="t s1_649">Here is how you might create a new MessageChannel and transfer one of its Message‐ </span>
<span id="ta_649" class="t s1_649">Ports to a worker: </span>
<span id="tb_649" class="t s3_649">// Create a custom communication channel </span>
<span id="tc_649" class="t s4_649">const </span><span id="td_649" class="t s5_649">threads </span><span id="te_649" class="t s6_649">= </span><span id="tf_649" class="t s5_649">require</span><span id="tg_649" class="t s7_649">(</span><span id="th_649" class="t s8_649">"worker_threads"</span><span id="ti_649" class="t s7_649">); </span>
<span id="tj_649" class="t s4_649">let </span><span id="tk_649" class="t s5_649">channel </span><span id="tl_649" class="t s6_649">= </span><span id="tm_649" class="t s4_649">new </span><span id="tn_649" class="t s5_649">threads</span><span id="to_649" class="t s7_649">.</span><span id="tp_649" class="t s5_649">MessageChannel</span><span id="tq_649" class="t s7_649">(); </span>
<span id="tr_649" class="t s3_649">// Use the worker's default channel to transfer one end of the new </span>
<span id="ts_649" class="t s3_649">// channel to the worker. Assume that when the worker receives this </span>
<span id="tt_649" class="t s3_649">// message it immediately begins to listen for messages on the new channel. </span>
<span id="tu_649" class="t s5_649">worker</span><span id="tv_649" class="t s7_649">.</span><span id="tw_649" class="t s5_649">postMessage</span><span id="tx_649" class="t s7_649">({ </span><span id="ty_649" class="t s5_649">command</span><span id="tz_649" class="t s6_649">: </span><span id="t10_649" class="t s8_649">"changeChannel"</span><span id="t11_649" class="t s7_649">, </span><span id="t12_649" class="t s5_649">data</span><span id="t13_649" class="t s6_649">: </span><span id="t14_649" class="t s5_649">channel</span><span id="t15_649" class="t s7_649">.</span><span id="t16_649" class="t s5_649">port1 </span><span id="t17_649" class="t s7_649">}, </span>
<span id="t18_649" class="t s7_649">[ </span><span id="t19_649" class="t s5_649">channel</span><span id="t1a_649" class="t s7_649">.</span><span id="t1b_649" class="t s5_649">port1 </span><span id="t1c_649" class="t s7_649">]); </span>
<span id="t1d_649" class="t s3_649">// Now send a message to the worker using our end of the custom channel </span>
<span id="t1e_649" class="t s5_649">channel</span><span id="t1f_649" class="t s7_649">.</span><span id="t1g_649" class="t s5_649">port2</span><span id="t1h_649" class="t s7_649">.</span><span id="t1i_649" class="t s5_649">postMessage</span><span id="t1j_649" class="t s7_649">(</span><span id="t1k_649" class="t s8_649">"Can you hear me now?"</span><span id="t1l_649" class="t s7_649">); </span>
<span id="t1m_649" class="t s3_649">// And listen for responses from the worker as well </span>
<span id="t1n_649" class="t s5_649">channel</span><span id="t1o_649" class="t s7_649">.</span><span id="t1p_649" class="t s5_649">port2</span><span id="t1q_649" class="t s7_649">.</span><span id="t1r_649" class="t s5_649">on</span><span id="t1s_649" class="t s7_649">(</span><span id="t1t_649" class="t s8_649">"message"</span><span id="t1u_649" class="t s7_649">, </span><span id="t1v_649" class="t s5_649">handleMessagesFromWorker</span><span id="t1w_649" class="t s7_649">); </span>
<span id="t1x_649" class="t s1_649">MessagePort objects are not the only ones that can be transferred. If you call </span><span id="t1y_649" class="t s2_649">postMes </span>
<span id="t1z_649" class="t s2_649">sage() </span><span id="t20_649" class="t s1_649">with a typed array as the message (or with a message that contains one or </span>
<span id="t21_649" class="t s1_649">more typed arrays nested arbitrarily deep within the message), that typed array (or </span>
<span id="t22_649" class="t s1_649">those typed arrays) will simply be copied by the structured clone algorithm. But typed </span>
<span id="t23_649" class="t s1_649">arrays can be large; for example, if you are using a worker thread to do image pro‐ </span>
<span id="t24_649" class="t s1_649">cessing on millions of pixels. So for efficiency, </span><span id="t25_649" class="t s2_649">postMessage() </span><span id="t26_649" class="t s1_649">also gives us the option </span>
<span id="t27_649" class="t s1_649">to transfer typed arrays rather than copying them. (Threads share memory by default. </span>
<span id="t28_649" class="t s1_649">Worker threads in JavaScript generally avoid shared memory, but when we allow this </span>
<span id="t29_649" class="t s1_649">kind of controlled transfer, it can be done very efficiently.) What makes this safe is </span>
<span id="t2a_649" class="t s1_649">that when a typed array is transferred to another thread, it becomes unusable in the </span>
<span id="t2b_649" class="t s1_649">thread that transferred it. In the image-processing scenario, the main thread could </span>
<span id="t2c_649" class="t s1_649">transfer the pixels of an image to the worker thread, and then the worker thread </span>
<span id="t2d_649" class="t s1_649">could transfer the processed pixels back to the main thread when it was done. The </span>
<span id="t2e_649" class="t s1_649">memory would not need to be copied, but it would never be accessible by two threads </span>
<span id="t2f_649" class="t s1_649">at once. </span>
<span id="t2g_649" class="t s1_649">To transfer a typed array instead of copying it, include the ArrayBuffer that backs the </span>
<span id="t2h_649" class="t s1_649">array in the second argument to </span><span id="t2i_649" class="t s2_649">postMessage()</span><span id="t2j_649" class="t s1_649">: </span>
<span id="t2k_649" class="t s4_649">let </span><span id="t2l_649" class="t s5_649">pixels </span><span id="t2m_649" class="t s6_649">= </span><span id="t2n_649" class="t s4_649">new </span><span id="t2o_649" class="t s5_649">Uint32Array</span><span id="t2p_649" class="t s7_649">(</span><span id="t2q_649" class="t s9_649">1024</span><span id="t2r_649" class="t s6_649">*</span><span id="t2s_649" class="t s9_649">1024</span><span id="t2t_649" class="t s7_649">); </span><span id="t2u_649" class="t s3_649">// 4 megabytes of memory </span>
<span id="t2v_649" class="t s3_649">// Assume we read some data into this typed array, and then transfer the </span>
<span id="t2w_649" class="t sa_649">16.11 Worker Threads </span><span id="t2x_649" class="t sa_649">| </span><span id="t2y_649" class="t sa_649">631 </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
